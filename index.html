<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Transcription + Translation</title>
</head>
<body style="font-family:system-ui;max-width:900px;margin:40px auto;padding:0 16px;">
  <h2>Upload Audio or Video</h2>
  <p style="margin-top:0;color:#555;">Powered by high-accuracy AI transcription + translation.</p>
  <input id="f" type="file" accept="audio/*,video/*" />
  <button id="go">Transcribe + Translate</button>
  <p id="s"></p>
  <div id="progressWrap" style="display:none;margin:12px 0 20px 0;">
    <progress id="p" value="0" max="100" style="width:100%;height:20px;"></progress>
    <div id="progressMeta" style="margin-top:8px;font-size:14px;line-height:1.5;"></div>
  </div>

  <h3>Transcript</h3>
  <textarea id="ar" style="width:100%;height:200px;"></textarea>

  <h3>Translation (English)</h3>
  <textarea id="en" style="width:100%;height:200px;"></textarea>

  <script>
    const f = document.getElementById('f');
    const s = document.getElementById('s');
    const ar = document.getElementById('ar');
    const en = document.getElementById('en');
    const p = document.getElementById('p');
    const progressWrap = document.getElementById('progressWrap');
    const progressMeta = document.getElementById('progressMeta');
    let lastShownProgress = 0;
    let lastShownBackendPercent = 0;
    const runningOnBackend =
      window.location.protocol.startsWith("http") &&
      (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") &&
      window.location.port === "8000";
    const API_BASE = runningOnBackend ? "" : "http://127.0.0.1:8000";

    const phaseLabel = (phase) => {
      const map = {
        queued: "Queued",
        checking_api_key: "Checking API key",
        initializing_openai: "Initializing OpenAI",
        initializing_local: "Initializing local model",
        transcribing: "Transcribing",
        translating: "Translating",
        complete: "Complete",
        failed: "Failed"
      };
      return map[phase] || phase || "Processing";
    };

    const fmtSeconds = (seconds) => {
      if (seconds == null) return "—";
      const n = Math.max(0, Math.round(seconds));
      const m = Math.floor(n / 60);
      const s = n % 60;
      return `${m}:${String(s).padStart(2, "0")}`;
    };

    const startJobWithUploadProgress = (formData) => {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `${API_BASE}/process`);

        xhr.upload.onprogress = (evt) => {
          if (!evt.lengthComputable) return;
          const uploadPercent = (evt.loaded / evt.total) * 100;
          const shownPercent = Math.min(10, uploadPercent * 0.1);
          p.value = shownPercent;
          progressMeta.innerHTML = `
            <div><strong>${uploadPercent.toFixed(1)}%</strong> • Uploading</div>
            <div>Sent: ${(evt.loaded / (1024 * 1024)).toFixed(2)} MB / ${(evt.total / (1024 * 1024)).toFixed(2)} MB</div>
          `;
        };

        xhr.onload = () => {
          let data = {};
          try {
            data = xhr.responseText ? JSON.parse(xhr.responseText) : {};
          } catch {
            data = { error: "Invalid JSON response from backend." };
          }
          resolve({ ok: xhr.status >= 200 && xhr.status < 300, status: xhr.status, data });
        };

        xhr.onerror = () => reject(new Error("Network error during upload."));
        xhr.send(formData);
      });
    };

    document.getElementById('go').onclick = async () => {
      if (!f.files[0]) return alert("Choose a file first.");

      s.textContent = "Uploading...";
      ar.value = "";
      en.value = "";
      p.value = 0;
      lastShownProgress = 0;
      lastShownBackendPercent = 0;
      progressMeta.textContent = "";
      progressWrap.style.display = "block";

      const fd = new FormData();
      fd.append("file", f.files[0]);

      let startData;
      let startOk;
      try {
        const startResult = await startJobWithUploadProgress(fd);
        startData = startResult.data;
        startOk = startResult.ok;
      } catch (e) {
        s.textContent = "Error: backend not reachable. Start the API server first.";
        return;
      }

      if (!startOk) {
        s.textContent = "Error: " + (startData.error || "unknown");
        return;
      }

      const jobId = startData.job_id;
      s.textContent = "Processing...";

      while (true) {
        let progressRes;
        let data;
        try {
          progressRes = await fetch(`${API_BASE}/progress/${jobId}`);
          data = await progressRes.json();
        } catch (e) {
          s.textContent = "Error: lost connection to backend.";
          break;
        }

        if (!progressRes.ok) {
          s.textContent = "Error: " + (data.error || "unknown");
          break;
        }

        const rawBackendPercent = data.progress_percent || 0;
        lastShownBackendPercent = Math.max(lastShownBackendPercent, rawBackendPercent);
        const rawProgress = 10 + (lastShownBackendPercent * 0.9);
        lastShownProgress = Math.max(lastShownProgress, rawProgress);
        p.value = lastShownProgress;
        progressMeta.innerHTML = `
          <div><strong>${lastShownBackendPercent.toFixed(1)}%</strong> • ${phaseLabel(data.phase)}</div>
          <div>Elapsed: ${fmtSeconds(data.elapsed_seconds)} • ETA: ${fmtSeconds(data.eta_seconds)}</div>
        `;

        if (data.status === "done") {
          s.textContent = "Done.";
          ar.value = data.transcript || data.arabic_transcript || "";
          en.value = data.translation || data.english_translation || "";
          break;
        }

        if (data.status === "error") {
          s.textContent = "Error: " + (data.error || "unknown");
          break;
        }

        await new Promise((r) => setTimeout(r, 1000));
      }
    };
  </script>
</body>
</html>
